<html>
  <head>
    <title>Balihoo | Web Designer Console</title>
    <style>
      body {
        margin: 0px;
        background-color: #efefef;
      }
      #toolbar {
        margin: 0px;
        padding: 15px;
        border: 0px;
      }
      iframe {
        border: 0px;
        border-top-color: black;
        border-top-style: inset;
        border-top-width: 3px;
        width: 100%;
        height: 100%;
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.11.2.js"></script>
    <script src="/$console/data/URI.js"></script>
  </head>
  <body>
    <div id="toolbar">
      <input id="nav" type="text" size="60" value="/"/>

      <label for="samples">Sample Data</label>
      <select name="samples" id="samples" value="default"></select>

      <label for="tests">Disable Tests</label>
      <input type="checkbox" name="tests" id="tests"/>
    </div>

   <script>
    var es;

    $(function() {
      var iframe = $('#contentFrame').get(0);
      var sel = $('#samples');
      var tests = $('#tests');
      var nav = $('#nav');
      es = new EventSource('/$console')

      nav.keyup(function (e) {
        if (e.keyCode == 13) {
          iframe.contentWindow.location = nav.val();
        }
      });

      es.onmessage = function(event) {
        e = JSON.parse(event.data);
        console.log("Got event " + e.event);
        if(e.event === 'reload') {
          // Reload happens when this script is update
          // Try to remember where we where by storing info in the new querystring
          uri = URI(window.location.href).removeSearch('__url')
            .addSearch('__url', iframe.contentWindow.location.href);
          window.location.href = uri.toString();
        } else if(e.event === 'navigate') {
          iframe.src = e.data.path;
        } else if(e.event === 'refresh') {

          // Repopulate the select dropdown
          sel.empty();
          $.each(e.data, function(key, value){
            sel.append($('<option>').attr('value', key).text(key));
          });
          setSelectedSample();

          // When the sample selection changes, update the querystring
          sel.change(function() {
            var uri = URI(iframe.contentWindow.location.href).removeSearch('__sample')
              .addSearch('__sample', sel.val());
            iframe.contentWindow.location.href = uri.toString();
          });

          setTestSelection();
          tests.change(function() {
            var uri = URI(iframe.contentWindow.location.href).removeSearch('__notests');
            if(tests.prop('checked'))
              uri.addSearch('__notests');
            iframe.contentWindow.location.href = uri.toString();
          });

          var frameUrl = iframe.contentWindow.location.href;
          // Set the initial path if it isn't already set
          if(frameUrl == 'about:blank' || frameUrl == '') {
            var search = URI(window.location).search(true);
            var newLocation = search['__url'] ? search['__url'] : '/';
            iframe.contentWindow.location = newLocation;
            nav.val(newLocation);
          } else {
            // Reload the iframe
            iframe.contentWindow.location.reload();
          }
        }
      }

      // When the iframe navigates, refresh the UI
      $('#contentFrame').load(function() {
        console.log("Frame is now" + iframe.contentWindow.location.href);
        setSelectedNav();
        setSelectedSample();
        setTestSelection();
      });

      // Repopulate the nav bar based on the iframe's location
      function setSelectedNav() {
        nav.val(iframe.contentWindow.location.href);
      }

      // Repopulate the selected sample based on the iframe's querystring
      function setSelectedSample() {
        var search = URI(iframe.contentWindow.location.href).search(true);
        sel.val(search['__sample'] ? search['__sample'] : 'default');
      }

      // Repopulate the selected sample based on the iframe's querystring
      function setTestSelection() {
        var search = URI(iframe.contentWindow.location.href).search(true);
        tests.prop('checked', search.hasOwnProperty('__notests'));
      }

      // Close the event source before unloading
      function cleanUp() {
        if(es !== null) {
          es.close();
          es = null;
        }
      }
      $(window).on('beforeunload', cleanUp);
      $(window).unload(cleanUp);
    });
    </script>

    <iframe id="contentFrame">
      Your browser does not support iframes. Bummer.
    </iframe>

   </body>
</html>


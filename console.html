<html>
  <head>
    <title>Balihoo | Web Designer Console</title>
    <style>
      body {
        margin: 0px;
        background-color: #efefef;
      }
      #toolbar {
        margin: 0px;
        padding: 15px;
        border: 0px;
      }
      iframe {
        border: 0px;
        border-top-color: black;
        border-top-style: inset;
        border-top-width: 3px;
        width: 100%;
        height: 100%;
      }
    </style>
    <script src="http://code.jquery.com/jquery-1.11.2.js"></script>
  </head>
  <body>
    <div id="toolbar">
      <input id="nav" type="text" size="60" value="/"/>
      <select id="samples" value="default"></select>
    </div>

   <script>
    var es;

    nav.onkeydown = function(evt) {
      if(evt.keyCode == 13)
        navChange($('#nav').val());
    }

    function navChange(location) {
      var iframe = $('#contentFrame').get(0);
      var nav = $('#nav');

      if(location === null)
        nav.val(iframe.contentWindow.location);
      else
        iframe.contentWindow.location = location;
    }

    function getParameterByName(name) {
      name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
      var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
        results = regex.exec(location.search);
      return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
 
    $(function() {
      var iframe = $('#contentFrame').get(0);
      es = new EventSource('/$console')
      var nav = $('#nav');
      es.onmessage = function(event) {
        e = JSON.parse(event.data);
        console.log("Got event " + e.event);
        if(e.event === 'reload') {
          es.close();
          window.location = window.location.pathname + '?__url='
            + encodeURIComponent(iframe.contentWindow.location);
        } else if(e.event === 'navigate') {
          iframe.src = e.data.path;
        } else if(e.event === 'refresh') {
          var sel = $('#samples');
          var selectedValue = sel.val() !== null && sel.val() !== '' ? sel.val() : 'default';
          sel.empty();
          $.each(e.data, function(key, value){
            sel.append($('<option>').attr('value', key).text(key));
          });

          sel.val(selectedValue);
          sel.change(function() {
            var url = nav.val().replace(/[\?&]?__sample=[^&]*/, '');
            var key = url.indexOf('?') === -1 ? '?' : '&';
            iframe.contentWindow.location =
              url + key + "__sample=" + encodeURIComponent(sel.val());
          });
          // Set the initial path
          url = getParameterByName('__url') || '/';
          navChange(url);
        }
      }

      $('#contentFrame').load(function() {
        navChange(null);
      });

      function cleanUp() {
        if(es !== null) {
          es.close();
          es = null;
        }
      }
      $(window).on('beforeunload', cleanUp);
      $(window).unload(cleanUp);
    });
    </script>

    <iframe id="contentFrame">
      Your browser does not support iframes. Bummer.
    </iframe>

   </body>
</html>

